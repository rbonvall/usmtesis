% Estilo de Tesis de la Universidad Técnica Federico Santa María
% Departamento de Informática.
% Valparaíso, Chile
%
% Modificado por Roberto Bonvallet, 2010.
%  * Correcciones de estilo y ortografía
%
% Modificado por Romina Torres y Rodrigo Salas Fuentes 
% 2002.
%
% Modificado de:
%-%  Dalhousie University thesis style
%-%  Dept. of Math. Stats. and Comp. Sci.
%
% Modificado de:
%
%-% Stanford University PhD thesis style -- modifications to the report style
%-% For LaTeX version 2.09
%-% Last edit Tue Sep 13 14:40:26 1988
%-% Last edit by Joseph Pallas

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{usmtesis}[2010]
\typeout{Tesis Info Style}
\RequirePackage{ifthen}
\RequirePackage{latexsym}
\RequirePackage{tabularx}
\RequirePackage{graphicx}

% Define la cabecera de la página para enumerarla solamente.
%\newcommand{\properpagestyle}{\pagestyle{myheadings}\markboth{}{}\markright{}}
\newcommand{\properpagestyle}{\pagestyle{plain}}

% Lo primero que se hace es ver si el reporte ha sido cargado. 
% Un error común es tratar de usar suthesis como un documentstyle.
\@ifundefined{chapter}{%
    \@latexerr{La opción de `usmtesis' debería ser usado %
               con el estilo de documento `report'}%
               {Usted debería leer la documentación de usmtesis.}}{}

% Se necesita un margen de 1" excepto en la página de binding la cual es de 1 1/2"
% Las Tesis son por un lado, por lo tanto no nos preopcupamos por \evensidemargin
%\oddsidemargin 0.5in
%\evensidemargin 0in
\marginparwidth 40pt
\marginparsep 10pt
%\topmargin 0pt
\headsep .5in
%\textheight 8.1in
%\textwidth 6in
\hoffset        -1.0in  % Seteo a 0 el margen izquierdo
\oddsidemargin   4cm    % Margen izquierdo (pag. impar)
%\oddsidemargin     0cm  % Ancho Legal 21,59cm
\evensidemargin  0.5cm  % Alto  Legal 35,56cm
\textwidth      15.5cm
\topmargin      -1.5cm
%\voffset           2cm  % Margen superior
\textheight       22cm
%\parindent      0em
%\parskip        2ex

% No permitir salto de páginas en hyphens (Esto dará algunos underfull vbox's,
% entonces una alternativa es usar \brokenpenalty=100 y manualmente buscar por
% y arreglar tales saltos de páginas.)
\brokenpenalty=10000

% Usar 1.37 veces el salto baseline-to-baseline normal 
\renewcommand{\baselinestretch}{1.37}

% Redefinir los macors utilizados para flotantes (incluyendo tablas y figuras)
% de manera tal que se usa un espaciamiento simple.
% (Notar que \def\figure{\@float{figure}set single spacing} no funciona
%  porque la figura tiene un argumento opcional.)
%
%\def\@xfloat#1[#2]{\ifhmode \@bsphack\@floatpenalty -\@Mii\else
%   \@floatpenalty-\@Miii\fi\def\@captype{#1}\ifinner
%      \@parmoderr\@floatpenalty\z@
%    \else\@next\@currbox\@freelist{\@tempcnta\csname ftype@#1\endcsname
%       \multiply\@tempcnta\@xxxii\advance\@tempcnta\sixt@@n
%       \@tfor \@tempa :=#2\do
%            {\if\@tempa h\advance\@tempcnta \@ne\fi
%             \if\@tempa t\advance\@tempcnta \tw@\fi
%             \if\@tempa b\advance\@tempcnta 4\relax\fi
%             \if\@tempa p\advance\@tempcnta 8\relax\fi
%     }\global\count\@currbox\@tempcnta}\@fltovf\fi
%    \global\setbox\@currbox\vbox\bgroup 
%    \def\baselinestretch{1}\@normalsize
%    \boxmaxdepth\z@
%    \hsize\columnwidth \@parboxrestore}

% Redefinir los macros utilizados para los pie de páginas para usar espaciamiento simple.
\long\def\@footnotetext#1{%
    \insert\footins{%
        \def\baselinestretch{1}\footnotesize
        \interlinepenalty\interfootnotelinepenalty 
        \splittopskip\footnotesep
        \splitmaxdepth \dp\strutbox \floatingpenalty \@MM
        \hsize\columnwidth \@parboxrestore
        \edef\@currentlabel{\csname p@footnote\endcsname\@thefnmark}\@makefntext
        {\rule{\z@}{\footnotesep}\ignorespaces#1\strut}%
    }%
}

%\long\def\@makecaption#1#2{%
%  \vskip\abovecaptionskip
%  \sbox\@tempboxa{{\small \textbf{#1}: #2}}%
%  \ifdim \wd\@tempboxa >\hsize
%    {\small \textbf{#1}: #2}\par
%  \else
%    \global \@minipagefalse
%    \hb@xt@\hsize{\hfil\box\@tempboxa\hfil}%
%  \fi
%  \vskip\belowcaptionskip}

% \author, \title son definidos en el reporte; aquís está el resto de los
% front que definen macros.
\def\university#1{\gdef\@university{#1}}
\def\address#1{\gdef\@address{#1}}
\def\dept#1{\gdef\@dept{#1}}
\def\faculty#1{\gdef\@faculty{#1}}
\def\profguia#1{\gdef\@profguia{#1}}
\def\profcorr#1{\gdef\@profcorr{#1}}
\def\profext#1{\gdef\@profext{#1}}
\def\twosupervisors{\two@supervisorstrue}
\def\submitdate#1{\gdef\@submitdate{#1}}
\def\copyrightyear#1{\gdef\@copyrightyear{#1}}
\def\degree#1{\gdef\@degree{#1}}
\def\degreeinitial#1{\gdef\@degreeinitial{#1}}
\def\msc{\degree{Master of Science}\degreeinitial{M.Sc.}}
\def\phd{\degree{Doctor of Philosophy}\degreeinitial{Ph.D.}\ph@dtrue}
\def\ma{\degree{Master of Arts}\degreeinitial{M.A.}}
\def\ingej{\degree{Ingeniero en Ejecuci\'on}\degreeinitial{Ing.Ej.}}
\def\ingciv{\degree{Ingeniero Civil}\degreeinitial{Ing.Civ.}}
\ingciv % grado por defecto
\def\magister{\degree{Mag\'ister en Ciencias de la Ingenier\'ia Inform\'atica}\degreeinitial{Mg.}\ph@dtrue}
\def\doctor{\degre{Doctor}\degreeinitial{Dr.}\ph@dtrue}
\def\@title{}
\def\@author{}
\def\@university{Universidad T\'ecnica Federico Santa Mar\'ia}
\def\@address{Av.~Espa\~na 1680, Valpara\'iso}
\def\@dept{Inform\'atica}
\def\@faculty{Graduados}
\def\@profguia{}\def\@profcorr{}\def\@profext{}
\def\@submitdate{\ifcase\the\month\or
  Enero\or Febrero\or Marzo\or Abril\or Mayo\or Junio\or
  Julio\or Agosto\or Septiembre\or Octubre\or Noviembre\or Deciembre\fi
  \space \number\the\year}
\def\@copyrightyear{\number\the\year}

\def\convocation#1#2{\gdef\@convocationmonth{#1}\gdef\@convocationyear{#2}}
\def\@convwarn{\typeout{Alerta:  El dia de la convocatoria puede estar incorrecto!}}

\def\dedicate#1{\dedic@tiontrue\gdef\dedication@text{#1}}

\def\draft{\renewcommand{\properpagestyle}{\pagestyle{myheadings}
\markright{{\rm Versi\'on  Borrador -- \today}}}\draft@modetrue\properpagestyle}
\def\nobib{\print@bibfalse}
\def\nolistoffigures{\figurespagefalse}
\def\nolistoftables{\tablespagefalse}
\def\nofront{\front@pagesfalse\permissionfalse\figurespagefalse\tablespagefalse}

% New if constructs:    Default conditions:
\newif\ifpermission     \permissiontrue  
\newif\iffigurespage    \figurespagetrue 
\newif\iftablespage     \tablespagetrue
\newif\iffront@pages    \front@pagestrue
\newif\ifthird@reader   \third@readerfalse
\newif\iffourth@reader  \fourth@readerfalse
\newif\iffifth@reader   \fifth@readerfalse
\newif\ifph@d           \ph@dfalse
\newif\iftwo@supervisors \two@supervisorsfalse
\newif\ifdraft@mode     \draft@modefalse
\newif\ifprint@bib      \print@bibtrue
\newif\ifdedic@tion     \dedic@tionfalse

\def\no@breaks#1{{\def\\{ \ignorespaces}#1}}    % disallow explicit line breaks

\def\titlep{
    \thispagestyle{empty}
    \hspace{-0.5cm}
    \begin{center}
        \begin{tabular}{c >{\centering\vspace{-1.7cm}}p{9.5cm} c}
            \includegraphics[width=65pt]{images/di} &
            \textsc{%
                \expandafter{\@university} \\
                Departamento de \expandafter{\@dept} \\  
                Valpara\'iso -- Chile%
            } &
            \includegraphics[width=65pt]{images/utfsm}
        \end{tabular}
    \end{center}
    %\end{tabular}
    \ifdraft@mode
        \begin{center}
            \Large BORRADOR \\ \large Impreso el \today
        \end{center}
    \fi
    \null\vskip1.2in
    \begin{center}
        \hyphenpenalty=10000\Large \textbf{\uppercase\expandafter{\@title}}
    \end{center}
    \vfill
    \begin{center}
        \large\rm Tesis presentada como requerimiento parcial\\
        \large\rm para optar al grado acad\'{e}mico de\\
        \vskip 0.2in
        \Large \uppercase\expandafter{\@degree} \\
        \Large\rm y al t\'itulo profesional de\\
        \Large \uppercase{Ingeniero Civil en Inform\'atica} \\
        \Large\rm por\\
        \Large\rm \textbf{\@author}
    \end{center}
    \vfill
    \begin{center}
        %Como requisito para optar al grado de:\\
        %\uppercase\expandafter{\@degree} \\

        %\uppercase\expandafter{\@university} \\
        %\uppercase\expandafter{\@address} \\
        \vskip0.3in       
        \large Comisi\'on Evaluadora: \\
        \large \expandafter{\@profguia} \\
        \large \expandafter{\@profcorr} \\
        %\large \expandafter{\@profext} \\
        %\uppercase\expandafter{\@submitdate}
    \end{center}
    \vskip0.25in
    \begin{center}
        %\rm \copyright\ Derechos de \@author, \@copyrightyear
        \uppercase\expandafter{\@submitdate}
    \end{center}\newpage}

\def\signature#1#2{\parbox[b]{1in}{\smash{#1}\vskip12pt}
\hfill \parbox[t]{3in}{\shortstack{\vrule width 3in height 0.4pt\\\small#2}}}

\def\signaturepage{%
    \setcounter{page}{2}
    \begin{quotation}
    \begin{center}
        \textsc{\expandafter{\@university} \\
        Departamento de \expandafter{\@dept} \\
        Valpara\'iso, Chile}
    \end{center}

    \null\vskip0.2in

    \noindent T\'ITULO DE LA TESIS:\\
    \textbf{\uppercase\expandafter{\@title}}

    \null\vskip0.2in

    \noindent AUTOR:\\
    \textbf{\uppercase\expandafter{\@author}}


    \null\vskip0.2in

    \noindent
    Tesis presentada como requerimiento parcial
    para optar al grado acad\'emico de
    \textbf{\@degree} y al t\'itulo profesional de
    \textbf{Ingeniero Civil en Inform\'atica} de la \@university.

    \iffourth@reader
        \def\sigskip{\vskip0.15in plus 0.2in minus 0.1in}
        \def\beginskip{\vskip0.3875in plus 0.2in minus 0.1in}
    \else
        \def\sigskip{\vskip0.4in plus 0.1in}
        \def\beginskip{\vskip0.5875in plus 0.1in}
    \fi

    \ifph@d
        \beginskip
        \signature{\@profguia}{Profesor Gu\'ia} \\
        \sigskip \signature{\@profcorr}{Profesor Correferente} \\
        \sigskip \signature{\@profext}{Profesor Externo} \\

    \else % not Ph.D. degree:
        \beginskip
        \signature{Profesor Gu\'ia}{\@profguia} \\
        \sigskip \signature{Profesor Correferente}{\@profcorr} \\
    \fi


    \vskip0.2in plus 1fill minus 0.1in
    \begin{flushright}
        \@submitdate. \\
        Valpara\'iso, Chile.
    \end{flushright}


    \end{quotation}
    \vfill\newpage\setcounter{page}{2} }


\def\beforepreface{
\typeout{Most over/underfulls in first few pages are the fault of dalthesis.}
\typeout{Ignore all them.  If uncorrectable errors occur, notify staff.}
    \pagenumbering{roman}
    \pagestyle{plain}
    \titlep
    \iffront@pages\signaturepage\else\addtocounter{page}{1}\fi
    %\ifpermission\permissionpage\else
    \addtocounter{page}{1}
    %\fi
    \iffront@pages\ifdedic@tion
        \newpage \begin{flushright}
        \ \vskip5in
        \Large\em\null\vskip1in
        \dedication@text
        \end{flushright}
    \fi\fi

    \iffront@pages\tableofcontents\else\addtocounter{page}{1}\fi
    \newpage
    \iftablespage
        \addcontentsline{toc}{chapter}{Index of Tables}\listoftables
        \newpage
    \fi
    \iffigurespage
        \addcontentsline{toc}{chapter}{Index of Figures}\listoffigures
        \newpage
    \fi
}
\def\nonumchapter#1{%
    \chapter*{#1}
    \addcontentsline{toc}{chapter}{#1}}

\def\prefacesection#1{%
    \chapter*{#1}
    \addcontentsline{toc}{chapter}{#1}}

\newenvironment{dedication}%
    {\newpage\begin{center}\Large\em\null\vskip1in}%
    {\vfill\end{center}}

\def\afterpreface{\newpage
    \pagenumbering{arabic}
    \pagestyle{plain}
    \typeout{Prefacio escrito.}
    \properpagestyle}

% Redefine \thebibliography para ir a una nueva página y colocar la entrada en la 
% tabla de contenidos
\let\@ldthebibliography\thebibliography
\renewcommand{\thebibliography}[1]{%
    \newpage
    \addcontentsline{toc}{chapter}{Bibliography}
    \@ldthebibliography{#1}
}

\let\@ldbibliography\bibliography
\renewcommand{\bibliography}[1]{\ifprint@bib\@ldbibliography{#1}\fi}

% Comenzar Normal.
\properpagestyle
